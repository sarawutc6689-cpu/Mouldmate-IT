<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหาข้อมูล User</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .search-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 1.4rem;
            color: #3498db;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .search-title i {
            margin-right: 10px;
            font-size: 1.6rem;
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-item {
            flex: 1;
            min-width: 250px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            background-color: white;
            transition: border-color 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn {
            background-color: #3498db;
            color: white;
        }
        
        .search-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .clear-btn {
            background-color: #ecf0f1;
            color: #7f8c8d;
        }
        
        .clear-btn:hover {
            background-color: #d5dbdb;
        }
        
        .results-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .results-title {
            font-size: 1.4rem;
            color: #3498db;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .results-title i {
            margin-right: 10px;
            font-size: 1.6rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        thead {
            background-color: #3498db;
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        td {
            padding: 15px;
            color: #2c3e50;
        }
        
        .department-cell {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .user-cell {
            color: #2c3e50;
        }
        
        .mail-cell {
            color: #27ae60;
        }
        
        .pass-cell {
            color: #e74c3c;
            font-family: monospace;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        
        .error-message {
            background-color: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            color: #c0392b;
            border-radius: 4px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .filter-group {
                flex-direction: column;
            }
            
            .filter-item {
                min-width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
    <!-- สำหรับไอคอน (ใช้ Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ระบบค้นหาข้อมูล User</h1>
            <p class="description">เลือก Department และ User เพื่อดูข้อมูล Mail และ Password ที่เกี่ยวข้อง</p>
        </header>
        
        <section class="search-section">
            <h2 class="search-title"><i class="fas fa-search"></i> เงื่อนไขการค้นหา</h2>
            
            <div class="filter-group">
                <div class="filter-item">
                    <label for="department-select"><i class="fas fa-building"></i> Department</label>
                    <select id="department-select">
                        <option value="">-- กรุณาเลือก Department --</option>
                        <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="user-select"><i class="fas fa-user"></i> User</label>
                    <select id="user-select">
                        <option value="">-- กรุณาเลือก User --</option>
                        <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                    </select>
                </div>
            </div>
            
            <div class="buttons">
                <button id="search-btn" class="search-btn"><i class="fas fa-search"></i> ค้นหาข้อมูล</button>
                <button id="clear-btn" class="clear-btn"><i class="fas fa-eraser"></i> ล้างข้อมูล</button>
            </div>
        </section>
        
        <section class="results-section">
            <h2 class="results-title"><i class="fas fa-table"></i> ผลลัพธ์การค้นหา</h2>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>กำลังโหลดข้อมูล...</p>
            </div>
            
            <div id="no-results" class="no-results" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>ไม่พบข้อมูล กรุณาเลือกเงื่อนไขการค้นหาใหม่</p>
            </div>
            
            <div id="error-message" class="error-message" style="display: none;"></div>
            
            <div id="results-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>User</th>
                            <th>Mail</th>
                            <th>Password</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <footer>
            <p>© 2023 ระบบค้นหาข้อมูล User | สคริปต์ URL: https://script.google.com/macros/s/AKfycbwqnJzqy8nycvqX-4k7OL8CPEqhMEiaEX2LTqC3rscfFatFudPiA7ZXzr2tfDEofuJOmw/exec</p>
        </footer>
    </div>

    <script>
        // URL ของ Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqnJzqy8nycvqX-4k7OL8CPEqhMEiaEX2LTqC3rscfFatFudPiA7ZXzr2tfDEofuJOmw/exec";
        
        // ตัวแปรเก็บข้อมูลทั้งหมด
        let allData = [];
        let departments = [];
        let users = [];
        
        // อ้างอิงถึงองค์ประกอบ HTML
        const departmentSelect = document.getElementById('department-select');
        const userSelect = document.getElementById('user-select');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loadingElement = document.getElementById('loading');
        const noResultsElement = document.getElementById('no-results');
        const errorMessageElement = document.getElementById('error-message');
        const resultsTable = document.getElementById('results-table');
        const resultsBody = document.getElementById('results-body');
        
        // เมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', function() {
            // ดึงข้อมูลจาก Google Sheets
            fetchData();
            
            // เพิ่ม event listeners
            searchBtn.addEventListener('click', searchData);
            clearBtn.addEventListener('click', clearFilters);
            
            // เมื่อ Department ถูกเปลี่ยน ให้กรอง User ที่เกี่ยวข้อง
            departmentSelect.addEventListener('change', function() {
                updateUserOptions();
            });
        });
        
        // ฟังก์ชันดึงข้อมูลจาก Google Sheets
        async function fetchData() {
            showLoading();
            
            try {
                // เรียก URL ของ Google Apps Script
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allData = data.data;
                    processData();
                    hideLoading();
                } else {
                    throw new Error(data.message || "เกิดข้อผิดพลาดในการดึงข้อมูล");
                }
            } catch (error) {
                hideLoading();
                showError(`ไม่สามารถดึงข้อมูลได้: ${error.message}`);
                console.error("Error fetching data:", error);
            }
        }
        
        // ประมวลผลข้อมูลเพื่อเตรียมสำหรับ dropdown
        function processData() {
            // สร้าง Set เพื่อเก็บค่าที่ไม่ซ้ำกัน
            const deptSet = new Set();
            const userSet = new Set();
            
            // เก็บข้อมูล Department และ User
            allData.forEach(row => {
                if (row.Department) deptSet.add(row.Department);
                if (row.User) userSet.add(row.User);
            });
            
            // แปลง Set เป็น Array และเรียงลำดับ
            departments = Array.from(deptSet).sort();
            users = Array.from(userSet).sort();
            
            // เติมข้อมูล Department dropdown
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
            
            // เติมข้อมูล User dropdown (ทั้งหมดก่อน)
            updateUserOptions();
        }
        
        // อัพเดตตัวเลือก User ตาม Department ที่เลือก
        function updateUserOptions() {
            // ล้างตัวเลือก User เดิม (เก็บเฉพาะตัวเลือกแรก)
            userSelect.innerHTML = '<option value="">-- กรุณาเลือก User --</option>';
            
            const selectedDept = departmentSelect.value;
            let filteredUsers = [];
            
            if (selectedDept) {
                // กรอง User เฉพาะใน Department ที่เลือก
                filteredUsers = Array.from(new Set(
                    allData
                        .filter(row => row.Department === selectedDept && row.User)
                        .map(row => row.User)
                )).sort();
            } else {
                // ถ้าไม่ได้เลือก Department ให้แสดง User ทั้งหมด
                filteredUsers = users;
            }
            
            // เติมข้อมูล User dropdown
            filteredUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
        }
        
        // ฟังก์ชันค้นหาข้อมูล
        function searchData() {
            const selectedDept = departmentSelect.value;
            const selectedUser = userSelect.value;
            
            // ตรวจสอบว่าผู้ใช้เลือกเงื่อนไขหรือไม่
            if (!selectedDept && !selectedUser) {
                showError("กรุณาเลือก Department หรือ User อย่างน้อยหนึ่งรายการ");
                return;
            }
            
            // กรองข้อมูลตามเงื่อนไข
            let filteredData = allData;
            
            if (selectedDept) {
                filteredData = filteredData.filter(row => row.Department === selectedDept);
            }
            
            if (selectedUser) {
                filteredData = filteredData.filter(row => row.User === selectedUser);
            }
            
            // แสดงผลลัพธ์
            displayResults(filteredData);
        }
        
        // แสดงผลลัพธ์ในตาราง
        function displayResults(data) {
            // ซ่อนข้อความอื่นๆ
            hideAllMessages();
            
            if (data.length === 0) {
                noResultsElement.style.display = 'block';
                return;
            }
            
            // ล้างตารางเก่า
            resultsBody.innerHTML = '';
            
            // เพิ่มแถวข้อมูล
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // Department
                const tdDept = document.createElement('td');
                tdDept.className = 'department-cell';
                tdDept.textContent = row.Department || '-';
                tr.appendChild(tdDept);
                
                // User
                const tdUser = document.createElement('td');
                tdUser.className = 'user-cell';
                tdUser.textContent = row.User || '-';
                tr.appendChild(tdUser);
                
                // Mail
                const tdMail = document.createElement('td');
                tdMail.className = 'mail-cell';
                tdMail.textContent = row.Mail || '-';
                tr.appendChild(tdMail);
                
                // Password
                const tdPass = document.createElement('td');
                tdPass.className = 'pass-cell';
                tdPass.textContent = row.Pass || '-';
                tr.appendChild(tdPass);
                
                resultsBody.appendChild(tr);
            });
            
            // แสดงตาราง
            resultsTable.style.display = 'block';
        }
        
        // ล้างตัวกรอง
        function clearFilters() {
            departmentSelect.value = '';
            userSelect.value = '';
            updateUserOptions();
            hideAllMessages();
        }
        
        // แสดงสถานะกำลังโหลด
        function showLoading() {
            hideAllMessages();
            loadingElement.style.display = 'block';
        }
        
        // ซ่อนสถานะกำลังโหลด
        function hideLoading() {
            loadingElement.style.display = 'none';
        }
        
        // แสดงข้อความผิดพลาด
        function showError(message) {
            hideAllMessages();
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
        }
        
        // ซ่อนข้อความทั้งหมด
        function hideAllMessages() {
            loadingElement.style.display = 'none';
            noResultsElement.style.display = 'none';
            errorMessageElement.style.display = 'none';
            resultsTable.style.display = 'none';
        }
        
        // สำหรับการทดสอบเมื่อไม่มี API จริง (ข้อมูลตัวอย่าง)
        function loadSampleData() {
            allData = [
                { Department: "IT", User: "john.doe", Mail: "john.doe@company.com", Pass: "P@ssw0rd1" },
                { Department: "IT", User: "jane.smith", Mail: "jane.smith@company.com", Pass: "P@ssw0rd2" },
                { Department: "HR", User: "alice.jones", Mail: "alice.jones@company.com", Pass: "P@ssw0rd3" },
                { Department: "HR", User: "bob.williams", Mail: "bob.williams@company.com", Pass: "P@ssw0rd4" },
                { Department: "Finance", User: "charlie.brown", Mail: "charlie.brown@company.com", Pass: "P@ssw0rd5" },
                { Department: "Finance", User: "david.miller", Mail: "david.miller@company.com", Pass: "P@ssw0rd6" },
                { Department: "Marketing", User: "eva.davis", Mail: "eva.davis@company.com", Pass: "P@ssw0rd7" },
                { Department: "Marketing", User: "frank.wilson", Mail: "frank.wilson@company.com", Pass: "P@ssw0rd8" },
                { Department: "Sales", User: "grace.taylor", Mail: "grace.taylor@company.com", Pass: "P@ssw0rd9" },
                { Department: "Sales", User: "henry.clark", Mail: "henry.clark@company.com", Pass: "P@ssw0rd10" }
            ];
            
            processData();
            hideLoading();
        }
        
        // สำหรับการทดสอบ: หาก Google Apps Script ไม่พร้อมใช้งาน ให้โหลดข้อมูลตัวอย่าง
        setTimeout(() => {
            if (allData.length === 0) {
                console.log("Using sample data for demonstration");
                loadSampleData();
            }
        }, 3000);
    </script>
</body>
</html>
